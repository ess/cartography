<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Entity - Cartography: Mapping REST APIs</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="An exploration of a portable technique for creating REST API clients">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme;
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            document.querySelector('html').classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="preface/overview.html">Howdy</a></li><li><a href="getting_started/overview.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li><a href="getting_started/gathering_information.html"><strong aria-hidden="true">1.1.</strong> Gathering Information</a></li><li><a href="getting_started/up_front_design.html"><strong aria-hidden="true">1.2.</strong> Up-front Design</a></li><li><a href="getting_started/external_dependencies.html"><strong aria-hidden="true">1.3.</strong> External Dependencies</a></li></ol></li><li><a href="implementing_a_driver/overview.html"><strong aria-hidden="true">2.</strong> Implementing A Driver</a></li><li><ol class="section"><li><a href="implementing_a_driver/get_the_first_verb.html"><strong aria-hidden="true">2.1.</strong> GET: the First Verb</a></li><li><a href="implementing_a_driver/post_the_reverbening.html"><strong aria-hidden="true">2.2.</strong> POST: the Reverbening</a></li><li><a href="implementing_a_driver/put_patch_the_verb_legacy.html"><strong aria-hidden="true">2.3.</strong> PUT/PATCH: the Verb Legacy</a></li><li><a href="implementing_a_driver/delete_the_final_verb.html"><strong aria-hidden="true">2.4.</strong> DELETE: the Final Verb</a></li><li><a href="implementing_a_driver/odds_and_ends.html"><strong aria-hidden="true">2.5.</strong> Odds and Ends</a></li></ol></li><li><a href="handling_endpoints/overview.html"><strong aria-hidden="true">3.</strong> Handling Endpoints</a></li><li><ol class="section"><li><a href="handling_endpoints/gathering_information.html"><strong aria-hidden="true">3.1.</strong> Gathering Information</a></li><li><a href="handling_endpoints/up_front_design.html"><strong aria-hidden="true">3.2.</strong> (WIP) Up-front Design</a></li></ol></li><li><a href="accounts/overview.html"><strong aria-hidden="true">4.</strong> (WIP) Accounts</a></li><li><ol class="section"><li><a href="accounts/entity.html" class="active"><strong aria-hidden="true">4.1.</strong> Entity</a></li><li><a href="accounts/all.html"><strong aria-hidden="true">4.2.</strong> List Accounts</a></li><li><a href="accounts/for_user.html"><strong aria-hidden="true">4.3.</strong> List Accounts For A User</a></li><li><a href="accounts/get.html"><strong aria-hidden="true">4.4.</strong> Show An Account</a></li><li><a href="accounts/update.html"><strong aria-hidden="true">4.5.</strong> Update An Account</a></li></ol></li><li><a href="users/overview.html"><strong aria-hidden="true">5.</strong> Users</a></li><li><a href="environments/overview.html"><strong aria-hidden="true">6.</strong> Environments</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                        </div>

                        <h1 class="menu-title">Cartography: Mapping REST APIs</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="accounts/entity.html#entity" id="entity"><h1>Entity</h1></a>
<p>This is the first entity that we're defining, so it's going to be a bit more work than the entities for pretty much all other endpoints. Let's review the general requirements for an Entity:</p>
<ul>
<li>It must have a general reader for any property</li>
<li>It must have a specific reader for all important properties</li>
<li>It should be immutable</li>
</ul>
<p>Why would we want the Entity to be immutable (or as close as we can get to it in Python)? In the end, I can bring up several arguments both for and against the notion of immutable data. The reality here is that after working for a long time with both sorts of systems, I've had a much better experience with those that treat data as data.</p>
<p>I don't have a lot of incredibly strong opinions about developering in general, but the idea that data should be data and nothing more is definitely a member of that club.</p>
<a class="header" href="accounts/entity.html#general-reader" id="general-reader"><h2>General Reader</h2></a>
<p>So, we want to be able to read any given property (by key) from the entity. Let's start with a test and work backwards from there. Since we're effectively just fetching a value from a dictionary, let's call the method <code>fetch</code> and add our test to <code>maury/tests/test_accounts.py</code>:</p>
<pre><code class="language-python">from unittest import TestCase

import maury.accounts as accounts

class TestAccounts(TestCase):
    def test_entity_fetch(self):
        data = {
                'id' : 'someaccount'
                }

        e = accounts.Entity(data = data)

        # When the property is known, we return the associated value
        self.assertEqual(e.fetch('id'), data['id'])

        # When the property is unknown, we return None
        self.assertEqual(e.fetch('unknown_key'), None)
</code></pre>
<p>That seems to cover the basic rules around <code>fetch</code>: if the key is in the Entity's data dictionary, we return the value for that key. Otherwise, we return <code>None</code>. Granted, if we run that test, we get an error about the class not existing. Let's fix that in <code>maury/accounts.py</code>:</p>
<pre><code class="language-python">class Entity(object):
    &quot;&quot;&quot;A data structure model for an Account&quot;&quot;&quot;

    pass
</code></pre>
<p>That's enough to run our tests and ... get a different error. Such is the nature of the test-driven development beast. Now it's complaining that we can't actually instantiate an Entity the way that we're trying to, so let's fix that:</p>
<pre><code class="language-python">class Entity(object):
    &quot;&quot;&quot;A data structure model for an Account&quot;&quot;&quot;

    def __init__(self, data = {}):
        &quot;&quot;&quot;Instantiate an Entity with some data&quot;&quot;&quot;

        self.__data = data

        # Ensure that __data is a dict
        if type(self.__data) is not dict:
            self.__data = {}
</code></pre>
<p>We're getting closer. Now we get yet another error, and it's because we haven't a <code>fetch</code> method for our Entity objects. Back to <code>maury/accounts.py</code>:</p>
<pre><code class="language-python">class Entity(object):
    &quot;&quot;&quot;A data structure model for an Account&quot;&quot;&quot;

    def __init__(self, data = {}):
        &quot;&quot;&quot;Instantiate an Entity with some data&quot;&quot;&quot;

        self.__data = data

        # Ensure that __data is a dict
        if type(self.__data) is not dict:
            self.__data = {}

    def fetch(self, key):
        &quot;&quot;&quot;Get a data property from the Entity
        
        Positional Arguments:
        key -- the name of the data property we wish to access
        &quot;&quot;&quot;

        pass
</code></pre>
<p>Now we're getting somewhere. We're no longer getting Python errors when we run our accounts test ... now we're getting an actual test failure:</p>
<pre><code>FAIL: test_entity_fetch (maury.tests.test_accounts.TestAccounts)
</code></pre>
<p>Looking a bit further, we see that our primary assertion is not being provided by our <code>fetch</code> implementation. That is, right now, <code>fetch</code> literally doesn't return anything (it returns the default Python return, <code>None</code>). So, let's make it return the expected information:</p>
<pre><code class="language-python">    def fetch(self, key):
        &quot;&quot;&quot;Get a data property from the Entity
        
        Positional Arguments:
        key -- the name of the data property we wish to access
        &quot;&quot;&quot;

        return self.__data[key]
</code></pre>
<p>Alright, our first assertion passes ... which leads us to another Python error in our tests:</p>
<pre><code>KeyError: unknown key
</code></pre>
<p>That indicates that our second scenario is failing (though we could arguably be testing that in a way to produce a failure rather than an error). So, what we want is for <code>fetch</code> to return the actual requested data if the key is known, but to return a default <code>None</code> value if the key is not known. Since it's guaranteed that an Entity's internal <code>__data</code> is a <code>dict</code>, we can use a handy method for that:</p>
<pre><code class="language-python">    def fetch(self, key):
        &quot;&quot;&quot;Get a data property from the Entity
        
        Positional Arguments:
        key -- the name of the data property we wish to access
        &quot;&quot;&quot;

        return self.__data.get(key, None)
</code></pre>
<p>Our tests are now passing, and that's awesome. We've implemented a general reader for any data property of an account entity.</p>
<a class="header" href="accounts/entity.html#specific-readers" id="specific-readers"><h2>Specific Readers</h2></a>
<p>We also require that the Entity have a specific reader for all &quot;important&quot; data properties to make things easier for the end-users of our client. We're nice folks like that. So, let's head back over to the <a href="https://developer.engineyard.com/accounts">Accounts docs</a> and figure out what some of the important properties are.</p>
<p>At least for now, I've narrowed it down to basically the following:</p>
<ul>
<li>id -- the identifier used on the API to reference the account</li>
<li>name -- the name used on the API to reference the account</li>
<li>emergency_contact -- the emergency contact for the account</li>
</ul>
<a class="header" href="accounts/entity.html#account-id" id="account-id"><h3>Account ID</h3></a>
<p>Let's start by adding a test to <code>maury/tests/test_accounts.py</code>:</p>
<pre><code class="language-python">    def test_entity_id(self):
        data = {
                'id' : 'someaccount'
                }

        good = accounts.Entity(data = data)
        bad = accounts.Entity(data = {})

        # An entity with an id returns that id
        self.assertEqual(good.id, data['id'])

        # An entity without an id returns None
        self.assertEqual(bad.id, None)
</code></pre>
<p>This test is actually quite a lot like our <code>fetch</code> test, as do the initial results. That being the case, let's go ahead and implement the <code>id</code> method by using the <code>fetch</code> method:</p>
<pre><code class="language-python">    @property
    def id(self):
        &quot;&quot;&quot;Get the account's ID&quot;&quot;&quot;

        return self.fetch('id')
</code></pre>
<p>Boom. Our tests pass, and we can move on to the next reader.</p>
<a class="header" href="accounts/entity.html#name-and-emergency-contact" id="name-and-emergency-contact"><h3>Name and Emergency Contact</h3></a>
<p>The other two specific readers are just riffs on the <code>id</code> reader. Let's go ahead and add the tests for those to <code>maury/tests/test_accounts.py</code>:</p>
<pre><code class="language-python">    def test_entity_name(self):
        data = {
                'name' : 'someaccount'
                }

        good = accounts.Entity(data = data)
        bad = accounts.Entity(data = {})

        # An entity with a name returns that name
        self.assertEqual(good.name, data['name'])

        # An entity without a name returns None
        self.assertEqual(bad.name, None)

    def test_entity_emergency_contact(self):
        data = {
                'emergency_contact' : '911'
                }

        good = accounts.Entity(data = data)
        bad = accounts.Entity(data = {})

        # An entity with an emergency contact returns that contact
        self.assertEqual(good.emergency_contact, data['emergency_contact'])

        # An entity without an emergency contact returns None
        self.assertEqual(bad.emergency_contact, None)
</code></pre>
<p>We already know that these tests fail, and we already know why ... there's not an implementation for these properties. Let's go ahead and add them to <code>maury/accounts.py</code>:</p>
<pre><code class="language-python">    @property
    def name(self):
        &quot;&quot;&quot;Get the account's name&quot;&quot;&quot;

        return self.fetch('name')

    @property
    def emergency_contact(self):
        &quot;&quot;&quot;Get the account's emergency contact&quot;&quot;&quot;

        return self.fetch('emergency_contact')
</code></pre>
<p>Boom. Our tests pass, and all of our (currently required) specific readers are implemented.</p>
<a class="header" href="accounts/entity.html#immutability" id="immutability"><h2>Immutability</h2></a>
<p>The last requirement that we have is that entities should be immutable. If I understand everything properly, this is unfortunately not technically possible for third-party types, like our <code>Entity</code> class.</p>
<p>To that end, we're using Python's social conventions to get as close as we can here (without dropping down to C to implement our data structure). That is, an Entity's data is stored in its <code>__data</code> member, and the social convention in Python is to not directly access methods and members that begin with <code>__</code>.</p>
<p>I'd personally prefer a stronger guarantee here. That said, this tradeoff also happens in just about all of the existing <code>maury</code> implementations (the notable exception being <code>maury-rust</code>).</p>
<p>So, while it's technically possible for somebody using our client to modify the makeup of a given account Entity, it would be bad form for them to do so.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="accounts/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="accounts/all.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="accounts/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="accounts/all.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if (getComputedStyle(document.querySelector(".fa")).fontFamily !== "FontAwesome") {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '_FontAwesome/css/font-awesome.css';
                document.head.insertBefore(link, document.head.firstChild)
            }
        </script>

        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
